let metricChart,bannerAutoPlayInterval,clubData=[],clubLeagueList=[],playerData=[],attendanceData=[],europeTopClubs=[],best11Filter={type:"all",value:null},rankingData={},scheduleData=[],isShowingArticleDetail=!1,predictionProbabilities={},updateDates={},blogPosts=[],blogInitialized=!1;const dataLoaded={attendance:!1,rankings:!1,europeTop:!1,prediction:!1,schedule:!1};function toHalfWidth(e){return"string"!=typeof e?e:e.replace(/[Ａ-Ｚａ-ｚ０-９．・－（）]/g,function(e){return String.fromCharCode(e.charCodeAt(0)-65248)}).replace(/　/g," ")}const majorLeagues=["プレミアリーグ","ラ・リーガ","ブンデスリーガ","セリエA","リーグ・アン"],clubAbbreviations={"北海道コンサドーレ札幌":"札幌","鹿島アントラーズ":"鹿島","浦和レッズ":"浦和","柏レイソル":"柏","ＦＣ東京":"FC東京","東京ヴェルディ":"東京V","ＦＣ町田ゼルビア":"町田","川崎フロンターレ":"川崎F","横浜Ｆ・マリノス":"横浜FM","湘南ベルマーレ":"湘南","アルビレックス新潟":"新潟","ジュビロ磐田":"磐田","名古屋グランパス":"名古屋","京都サンガF.C.":"京都","ガンバ大阪":"G大阪","セレッソ大阪":"C大阪","ヴィッセル神戸":"神戸","サンフレッチェ広島":"広島","アビスパ福岡":"福岡","サガン鳥栖":"鳥栖","ベガルタ仙台":"仙台","ブラウブリッツ秋田":"秋田","モンテディオ山形":"山形","いわきＦＣ":"いわき","水戸ホーリーホック":"水戸","栃木ＳＣ":"栃木SC","ザスパ群馬":"群馬","ジェフユナイテッド千葉":"千葉","横浜ＦＣ":"横浜FC","ヴァンフォーレ甲府":"甲府","清水エスパルス":"清水","藤枝ＭＹＦＣ":"藤枝","ファジアーノ岡山":"岡山","レノファ山口ＦＣ":"山口","徳島ヴォルティス":"徳島","愛媛ＦＣ":"愛媛","Ｖ・ファーレン長崎":"長崎","ロアッソ熊本":"熊本","大分トリニータ":"大分","鹿児島ユナイテッドＦＣ":"鹿児島","ＦＣ今治":"今治","ヴァンラーレ八戸":"八戸","いわてグルージャ盛岡":"岩手","福島ユナイテッドＦＣ":"福島","ＲＢ大宮アルディージャ":"大宮","Ｙ．Ｓ．Ｃ．Ｃ．横浜":"YS横浜","ＳＣ相模原":"相模原","松本山雅ＦＣ":"松本","ＡＣ長野パルセイロ":"長野","カターレ富山":"富山","ツエーゲン金沢":"金沢","アスルクラロ沼津":"沼津","ＦＣ岐阜":"岐阜","ＦＣ大阪":"FC大阪","奈良クラブ":"奈良","ガイナーレ鳥取":"鳥取","カマタマーレ讃岐":"讃岐","ギラヴァンツ北九州":"北九州","テゲバジャーロ宮崎":"宮崎","ＦＣ琉球":"琉球","栃木シティ":"栃木C","高知ユナイテッドSC":"高知"},europeClubAbbreviations={"レアル・マドリード":"Rマドリード","マンチェスター・シティ":"マンC","パリ・サンジェルマン":"PSG","バイエルン・ミュンヘン":"バイエルン","マンチェスター・ユナイテッド":"マンU","トッテナム・ホットスパー":"トッテナム","リヴァプール":"リヴァプール","チェルシー":"チェルシー","アーセナル":"アーセナル","ユヴェントス":"ユヴェントス","ボルシア・ドルトムント":"ドルトムント","アトレティコ・マドリード":"Aマドリード","インテル・ミラノ":"インテル","ACミラン":"ミラン","ウェストハム・ユナイテッド":"ウェストハム","アストン・ヴィラ":"アストンヴィラ","ニューカッスル・ユナイテッド":"ニューカッスル","オリンピック・マルセイユ":"マルセイユ","オリンピック・リヨン":"リヨン"};async function showPage(e,t,n=!1){try{window.scrollTo(0,0),document.querySelectorAll(".page-section").forEach(e=>e.classList.remove("visible"));const a=document.getElementById(e);a&&a.classList.add("visible"),document.querySelectorAll(".page-title-row").forEach(e=>e.style.display="none");let o="europe-top20"===e?"europe-top20":e;const l=document.getElementById("page-title-"+o);l&&(l.style.display="flex"),"blog"!==e||isShowingArticleDetail?"blog"!==e&&(document.getElementById("blog-content").style.display="none",document.getElementById("blog-list-container").style.display="flex",document.getElementById("pagination").style.display="block"):showBlogList(),updateNavActiveState(e,t);const i=document.getElementById("score-method-btn"),s=document.querySelector(".carousel-container");if("top"===e?(i&&(i.style.display="block"),s&&(s.style.display="block"),bannerAutoPlayInterval||setupCarousel("banner-carousel",4e3)):(i&&(i.style.display="none"),s&&(s.style.display="none"),stopBannerAutoPlay()),!n){const t={page:e},n=`#${e}`;history.pushState(t,"",n)}switch(e){case"metrics":clubData.length>0&&setTimeout(()=>showMetricChart(document.getElementById("metric-select").value),0);break;case"history":clubData.length>0&&renderHistory(clubData);break;case"attendance":await loadAttendanceData(),initAttendancePage();break;case"rankings":await loadRankingData(),initRankingPage();break;case"prediction":await loadPredictionData(),initPredictionPage();break;case"europe-top20":await loadEuropeTopClubsData(),renderEuropeTop20Table();break;case"introduce":clubData.length>0&&renderClubLeagueTable("J1");break;case"europe":playerData.length>0&&(window.innerWidth>768?showPlayerTable():initEuropeMobilePage());break;case"best11":playerData.length>0&&initBest11Page();break;case"simulation":clubData.length>0&&initSimulationPage()}}finally{const e=document.getElementById("nav-links");e&&e.classList.contains("open")&&(e.classList.remove("open"),document.getElementById("menu-overlay").classList.remove("open"),document.querySelectorAll(".nav-dropdown.menu-open").forEach(e=>e.classList.remove("menu-open")))}}function updateNavActiveState(e,t){document.querySelectorAll(".nav-links button").forEach(e=>e.classList.remove("active"));let n=t;if(!n){const t={top:"#nav-analysis-btn",metrics:"button[onclick*=\"showPage('metrics'\"]",attendance:"button[onclick*=\"showPage('attendance'\"]",history:"button[onclick*=\"showPage('history'\"]",introduce:"button[onclick*=\"showPage('introduce'\"]",rankings:"#nav-rankings-btn",prediction:"button[onclick*=\"showPage('prediction'\"]",simulation:"#nav-simulation-btn",best11:"button[onclick*=\"showPage('best11'\"]",europe:"#nav-europe-btn","europe-top20":"button[onclick*=\"showPage('europe-top20'\"]",blog:"button[onclick*=\"showPage('blog'\"]"};t[e]&&(n=document.querySelector(t[e]))}if(n){n.classList.add("active");const e=n.closest(".nav-dropdown");e&&e.querySelector("button").classList.add("active")}}async function showArticleDetail(e,t,n=!1){isShowingArticleDetail=!0;const a=document.getElementById("blog-list-container"),o=document.getElementById("pagination"),l=document.getElementById("blog-content");a&&(a.style.display="none"),o&&(o.style.display="none");try{const a=await fetch(`/posts/${e}.md`);if(!a.ok)throw new Error(`Markdownファイルが見つかりません: ${e}.md`);const o=(await a.text()).replace(/^---[\s\S]*?---/,"").trim(),i=marked.parse(o);if(l){let a,o;if("prediction-logic-explainer"===e)a='<a href="#prediction" onclick="event.preventDefault(); showPage(\'prediction\', null);" style="color:#aaa; font-weight:bold; text-decoration:none; border:1px solid #aaa; padding: 8px 20px; border-radius:8px; transition: all 0.2s;"> « シミュレーションに戻る </a>',o='<a href="#blog" onclick="event.preventDefault(); showPage(\'blog\', null);" style="color:#299ad3; font-weight:bold; text-decoration:none; border:1px solid #299ad3; padding: 8px 20px; border-radius:8px; transition: all 0.2s;"> 記事一覧に戻る » </a>';else{a='<a href="#top" onclick="event.preventDefault(); showPage(\'top\', null);" style="color:#aaa; font-weight:bold; text-decoration:none; border:1px solid #aaa; padding: 8px 20px; border-radius:8px; transition: all 0.2s;"> « ホームに戻る </a>';const s={"prediction-intro":{page:"prediction",name:"シーズン予測"},"best11-intro":{page:"best11",name:"ベスト11メーカー"},"simulation-intro":{page:"simulation",name:"シミュレーター"},"attendance-intro":{page:"attendance",name:"平均観客数"},"europe-intro":{page:"europe",name:"5大リーグ"},"bigclub-challenge":{page:"top",name:"ビッグクラブ指数"}};s[e]?(({page:t,name:n}=s[e]),o=`<a href="#${t}" onclick="event.preventDefault(); showPage('${t}', null);" style="color:#299ad3; font-weight:bold; text-decoration:none; border:1px solid #299ad3; padding: 8px 20px; border-radius:8px; transition: all 0.2s;"> ${n}に戻る » </a>`):o='<a href="#blog" onclick="event.preventDefault(); showPage(\'blog\', null);" style="color:#299ad3; font-weight:bold; text-decoration:none; border:1px solid #299ad3; padding: 8px 20px; border-radius:8px; transition: all 0.2s;"> 記事一覧に戻る » </a>'}const s=` <div style="text-align:center; margin-top:3em; display:flex; justify-content:center; gap:20px;"> ${a} ${o} </div> `;l.innerHTML=`${i}${s}`,l.style.display="block",showPage("blog",null,!0);const r=document.querySelector("#page-title-blog h1");if(r&&(r.textContent=t),window.scrollTo({top:0,behavior:"smooth"}),!n){const n={page:"blog",slug:e,title:t},a=`#blog/${e}`;history.pushState(n,t,a)}}}catch(e){console.error("記事詳細の読み込みエラー:",e),l&&(l.innerHTML="記事の読み込みに失敗しました。")}finally{isShowingArticleDetail=!1}}function showBlogList(){isShowingArticleDetail=!1;const e=document.getElementById("blog-list-container"),t=document.getElementById("pagination"),n=document.getElementById("blog-content"),a=document.querySelector("#page-title-blog h1");a&&(a.textContent="記事・ブログ"),e&&(e.style.display="flex"),t&&(t.style.display="block"),n&&(n.style.display="none"),blogInitialized&&renderArticleList(currentPage)}function handleInitialURL(){const e=location.hash.substring(1);if(e)if(e.startsWith("blog/")){const t=e.replace("blog/",""),n=blogPosts.find(e=>e.slug===t);n?showArticleDetail(n.slug,n.title):showPage("top")}else{const t=document.getElementById(e);t&&t.classList.contains("page-section")?showPage(e):showPage("top")}else showPage("top"),history.replaceState({page:"top"},"","#top")}async function loadAttendanceData(){if(dataLoaded.attendance)return;const[e,t]=await Promise.all([fetch("data/attendancefigure.csv"),fetch("data/update_dates.json")]),[n,a]=await Promise.all([e.text(),t.json()]);let o=n.trim().split("\n"),l=o[0].split(",").map(e=>e.trim());attendanceData=o.slice(1).map(e=>{const t=e.split(","),n={};return l.forEach((e,a)=>{const o=t[a]?t[a].trim():"";["年","年間最高観客数","年間最低観客数","ゲーム数"].includes(e)?n[e]=parseInt(o)||0:n[e]="平均観客数"===e?parseFloat(o)||0:o}),n}),attendanceData.lastModified=a["attendancefigure.csv"],dataLoaded.attendance=!0}async function loadRankingData(){if(dataLoaded.rankings)return;const[e,t,n,a]=await Promise.all([fetch("data/j1rank.csv"),fetch("data/j2rank.csv"),fetch("data/j3rank.csv"),fetch("data/update_dates.json")]),[o,l,i,s]=await Promise.all([e.text(),t.text(),n.text(),a.json()]),r=e=>{if(!e||""===e.trim())return[];const t=e.trim().split("\n"),n=t[0].split(",").map(e=>e.trim());return t.slice(1).map(e=>{const t=e.split(","),a={};return n.forEach((e,n)=>{a[e]=t[n]?t[n].trim():""}),a})};rankingData.J1={data:r(o),updated:s["j1rank.csv"]},rankingData.J2={data:r(l),updated:s["j2rank.csv"]},rankingData.J3={data:r(i),updated:s["j3rank.csv"]},dataLoaded.rankings=!0}async function loadPredictionData(){if(dataLoaded.prediction)return;const[e,t]=await Promise.all([fetch("data/prediction_probabilities.json"),fetch("data/update_dates.json")]);predictionProbabilities=await e.json(),updateDates=await t.json(),dataLoaded.prediction=!0}async function loadEuropeTopClubsData(){if(dataLoaded.europeTop)return;const e=await fetch("data/europebigclub.csv"),t=(await e.text()).trim().split("\n");europeTopClubs=t.slice(1).map(e=>(e=>{const t=[];let n="",a=!1;for(let o=0;o<e.length;o++){const l=e[o];'"'===l?a=!a:","!==l||a?n+=l:(t.push(n.trim()),n="")}return t.push(n.trim()),t})(e)),dataLoaded.europeTop=!0}function initRankingPage(){const e=document.getElementById("rank-buttons");e.dataset.initialized||(e.dataset.initialized="true"),showRankingTable("J1")}function initPredictionPage(){const e=document.getElementById("prediction-league-tabs");e.dataset.initialized||(e.innerHTML='\n            <button class="rank-tab-btn" onclick="showPredictionView(\'J1\')">J1</button>\n            <button class="rank-tab-btn" onclick="showPredictionView(\'J2\')">J2</button>\n            <button class="rank-tab-btn" onclick="showPredictionView(\'J3\')">J3</button>\n            <button id="prediction-help-btn" onclick="document.getElementById(\'prediction-help-pop\').style.display=\'block\'">シーズン予測とは？</button>\n        ',e.dataset.initialized="true"),showPredictionView("J1")}function toggleSubMenu(e,t){t.preventDefault(),t.stopPropagation();const n=e.parentElement;document.querySelectorAll(".nav-links .nav-dropdown.menu-open").forEach(e=>{e!==n&&e.classList.remove("menu-open")}),n.classList.toggle("menu-open")}function updateCopyButtonText(){const e=document.getElementById("copy-best11-img-btn");e&&(window.innerWidth<=768?e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg><span>ダウンロード</span>':e.innerHTML="画像をコピー")}function renderEuropeTop20Table(){const e=document.getElementById("europe-top20");if(!e||0===europeTopClubs.length)return;const t=window.innerWidth<=768;let n='<div class="data-source-note">※データソース: Deloitte, Transfermarkt (1ユーロ=165円で計算)</div>';n+="<table><thead><tr>",["順位","国","リーグ","クラブ名","売上高 (億円)","平均観客数"].forEach(e=>n+=`<th>${e}</th>`),n+="</tr></thead><tbody>",europeTopClubs.forEach((e,a)=>{n+="<tr>",n+=`<td>${a+1}</td>`,n+=`<td>${e[0]||"-"}</td>`,n+=`<td>${e[1]||"-"}</td>`;let o=e[2]||"-";t&&europeClubAbbreviations[o]&&(o=europeClubAbbreviations[o]),n+=`<td>${o}</td>`;let l="-";if(e[4]){const n=parseFloat(e[4]);l=t?Math.round(n).toLocaleString():n.toLocaleString()}n+=`<td>${l}</td>`,n+=`<td>${e[5]?parseInt(e[5]).toLocaleString():"-"}</td>`,n+="</tr>"}),n+="</tbody></table>",e.innerHTML=n}function renderBig5(e){const t=e.slice(0,5),n=document.getElementById("big5-cards");n.innerHTML="";const a=document.createElement("div");a.className="big5-row";const o=document.createElement("div");o.className="big5-row",t.forEach((e,t)=>{let n="local";e.sum>=30?n="top-club":e.sum>=20?n="potential-big":e.sum>=5&&(n="middle");const l=e.name.length>=10,i=document.createElement("div");i.className=`club-card ${n} rank-${t+1}`+(l?" long-title":""),i.innerHTML=`<h3 class="club-title">${e.name}</h3><div class="score-val">スコア：${e.sum.toFixed(1)}</div>`,t<3?a.appendChild(i):o.appendChild(i)}),n.appendChild(a),n.appendChild(o)}function renderOthers(e){const t=e.slice(5),n=document.getElementById("club-categories");n.innerHTML="";const a=document.createElement("table"),o=a.createTHead().insertRow();["順位","クラブ名","合算スコア","区分"].forEach(e=>{const t=document.createElement("th");t.textContent=e,o.appendChild(t)});const l=a.createTBody();t.forEach((e,t)=>{let n,a;e.sum>=30?(n="トップクラブ",a="top-club"):e.sum>=20?(n="潜在的ビッグクラブ",a="potential-big"):e.sum>=5?(n="中堅クラブ",a="middle"):(n="ローカルクラブ",a="local");const o=l.insertRow();o.className=a,[t+6,e.name,e.sum.toFixed(1),n].forEach(e=>{const t=document.createElement("td");t.textContent=e,o.appendChild(t)})}),n.appendChild(a)}function showMetricChart(e){const t=clubData.map(t=>t[e]),n=clubData.map(e=>e.name);metricChart&&metricChart.destroy();const a=document.getElementById("metricChart").getContext("2d");metricChart=new Chart(a,{type:"bar",data:{labels:n,datasets:[{label:{revenue:"売上高（億円）",audience:"平均観客動員（人数）",titles:"タイトル数"}[e],data:t,backgroundColor:n.map((e,t)=>{let n=clubData[t].sum;return n>=30?"#e94444bb":n>=20?"#22bbf0cc":n>=5?"#bbbbbbc8":"#232947bb"}),borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,scales:{x:{beginAtZero:!0,ticks:{color:"#111"}},y:{ticks:{autoSkip:!1,color:"#111"}}},plugins:{legend:{labels:{color:"#111"}},title:{display:!1}}}})}function renderHistory(e){const t=document.getElementById("jleague-history");t.innerHTML="";const n=document.createElement("table"),a=n.createTHead().insertRow();["クラブ名","J1過去10年在籍年数","J1過去10年平均順位","J1過去10年在籍スコア"].forEach(e=>{const t=document.createElement("th");t.textContent=e,a.appendChild(t)});const o=n.createTBody(),l=window.innerWidth<=768;e.forEach(e=>{const t=o.insertRow();let n=e.name;if(l){const t=toHalfWidth(e.name);for(const e in clubAbbreviations)if(toHalfWidth(e)===t){n=clubAbbreviations[e];break}}[n,e.l,e.m,e.o].forEach(e=>{const n=document.createElement("td");n.textContent=e,t.appendChild(n)})}),t.appendChild(n)}function renderClubLeagueTable(e){if(0===clubLeagueList.length)return;const t=document.getElementById("club-league-table"),n=clubLeagueList.filter(t=>t.p===e);if(!n.length)return void(t.innerHTML='<div style="padding:16px; color:white;">このリーグのクラブデータはありません</div>');let a=`<table><thead><tr><th>クラブ名</th></tr></thead><tbody> ${n.map(e=>`<tr><td style="cursor:pointer; color:#3cf;" onclick="showClubStatus('${e.name}')">${e.name}</td></tr>`).join("")} </tbody></table>`;t.innerHTML=a}function showClubStatus(e){const t=clubData.find(t=>t.name===e);if(!t)return;const n=clubData.findIndex(t=>t.name===e)+1,a=` <div style="font-size:1.2rem; font-weight:bold; color:#97d7ff; letter-spacing:0.06em;">${e}</div> <div class="club-status-grid"> <div class="status-item"> <span class="status-label">👑 ビッグクラブスコア</span> <span class="status-value score">${t.sum?t.sum.toFixed(1):"-"} (${n}位)</span> </div> <div class="status-item"> <span class="status-label">🏅 所属リーグ</span> <span class="status-value">${t.p||"-"}</span> </div> <div class="status-item"> <span class="status-label">💰 売上高</span> <span class="status-value">${t.revenue||"-"} 億円</span> </div> <div class="status-item"> <span class="status-label">👥 平均観客数</span> <span class="status-value">${(t.audience||"-").toLocaleString()} 人</span> </div> <div class="status-item"> <span class="status-label">🏆 タイトル獲得数</span> <span class="status-value">${t.titles||"-"}</span> </div> <div class="status-item"> <span class="status-label">📊 J1過去10年平均順位</span> <span class="status-value">${t.m||"-"} 位</span> </div> </div> <button onclick="document.getElementById('club-status-board').style.display='none';" style="position:absolute;top:13px;right:14px; background:#29b6e6; border:none; border-radius:7px; color:#fff; padding:5px 13px; font-size:1.01em; cursor:pointer;">閉じる</button> `,o=document.getElementById("club-status-board");o.innerHTML=a,o.style.display="block"}function showPlayerTable(e){const t=document.getElementById("player-table-wrap"),n=["プレミアリーグ","ブンデスリーガ","セリエA","ラリーガ","リーグアン"];let a=playerData.filter(e=>n.includes(e["リーグ"])),o="";const l={"イングランド":"プレミアリーグ","スペイン":"ラ・リーガ","ドイツ":"ブンデスリーガ","イタリア":"セリエA","フランス":"リーグ・アン"};if(e?(a=a.filter(t=>t["国"]===e),o=l[e]||e):o="5大リーグ",a.sort((e,t)=>(parseInt(e["年齢"])||99)-(parseInt(t["年齢"])||99)),0===a.length)return void(t.innerHTML='<div style="color:#ffe;padding:16px; text-align:center;">該当する選手がいません。</div>');const i=["No.","国","所属クラブ","選手名","年齢","ポジション","詳細"];let s=`<h3 style="text-align:center;color:#ffd700;">${o}の日本人選手</h3>`+`<table style="font-size: 0.88rem;"><thead><tr>${i.map(e=>`<th>${e}</th>`).join("")}</tr></thead><tbody>`;a.forEach((e,t)=>{s+="<tr>",s+=`<td>${t+1}</td>`,i.slice(1).forEach(t=>{s+=`<td>${e[t]||""}</td>`}),s+="</tr>"}),s+="</tbody></table>",t.innerHTML=s}document.addEventListener("DOMContentLoaded",()=>{Promise.all([fetch("data/data.csv").then(e=>e.ok?e.text():Promise.reject(`data.csv: ${e.status}`)),fetch("data/playerdata.csv").then(e=>e.ok?e.text():Promise.reject(`playerdata.csv: ${e.status}`)),fetch("/posts/index.json").then(e=>e.ok?e.json():Promise.reject(`index.json: ${e.status}`))]).then(([e,t,n])=>{let a,o;a=e.trim().split("\n"),o=a[0].split(",").map(e=>e.trim()),clubData=a.slice(1).map(e=>{const t=e.split(","),n={};return o.forEach((e,a)=>n[e]=t[a]?t[a].trim():""),n.name=n["クラブ名"]||"N/A",n.revenue=parseFloat(n["売上高（億円）"])||0,n.audience=parseInt(n["平均観客動員数"])||0,n.titles=parseInt(n["タイトル計"])||0,n.sum=parseFloat(n["総合的ビッグクラブスコア"])||0,n.l=n["過去10年J1在籍年数"]||"0",n.m=n["J1在籍10年平均順位"]||"N/A",n.o=n["J1在籍10年平均順位スコア"]||"N/A",n.p=n["所属リーグ"]||"N/A",n}),clubData.sort((e,t)=>t.sum-e.sum),clubLeagueList=clubData,a=t.trim().split("\n"),o=a[0].split(",").map(e=>e.trim()),playerData=a.slice(1).map(e=>{const t=e.split(","),n={};return o.forEach((e,a)=>n[e]=t[a]?t[a].trim():""),n}),Array.isArray(n)&&(blogPosts=n.sort((e,t)=>new Date(t.date)-new Date(e.date)),blogInitialized=!0),renderBig5(clubData),renderOthers(clubData),renderBest11Filters(),handleInitialURL()}).catch(e=>{console.error("基本データの読み込みに失敗しました:",e),document.body.innerHTML='<div style="color:red; text-align:center; padding: 20px;">サイトの基本データの読み込みに失敗しました。<br>リロードしてみてください。</div>'}),setupEventListeners(),updateCopyButtonText(),window.addEventListener("resize",updateCopyButtonText),setupFooterButtonObserver(),window.addEventListener("popstate",e=>{if(e.state){const{page:t,slug:n,title:a}=e.state;"blog"===t&&n?showArticleDetail(n,a,!0):showPage(t,null,!0)}else showPage("top",null,!0)})}),window.nowSelectedPosKey=null;let best11Formation="343",best11Selected={};const best11Positions={343:[{key:"GK",label:"GK"},{key:"CB1",label:"CB1"},{key:"CB2",label:"CB2"},{key:"CB3",label:"CB3"},{key:"MF1",label:"MF1"},{key:"MF2",label:"MF2"},{key:"MF3",label:"MF3"},{key:"MF4",label:"MF4"},{key:"MF5",label:"MF5"},{key:"MF6",label:"MF6"},{key:"FW",label:"FW"}],433:[{key:"GK",label:"GK"},{key:"CB1",label:"CB1"},{key:"CB2",label:"CB2"},{key:"CB3",label:"CB3"},{key:"CB4",label:"CB4"},{key:"MF1",label:"MF1"},{key:"MF2",label:"MF2"},{key:"MF3",label:"MF3"},{key:"MF4",label:"MF4"},{key:"MF5",label:"MF5"},{key:"FW",label:"FW"}]},best11PosCoords={343:{GK:{top:290,left:140},CB1:{top:225,left:50},CB2:{top:235,left:140},CB3:{top:225,left:230},MF1:{top:165,left:90},MF2:{top:165,left:190},MF3:{top:120,left:40},MF4:{top:120,left:240},MF5:{top:60,left:70},FW:{top:25,left:140},MF6:{top:60,left:210}},433:{GK:{top:290,left:140},CB1:{top:200,left:38},CB2:{top:235,left:100},CB3:{top:235,left:190},CB4:{top:200,left:240},MF1:{top:155,left:140},MF2:{top:130,left:55},MF3:{top:130,left:225},MF4:{top:70,left:70},FW:{top:25,left:140},MF5:{top:70,left:210}}};function renderBest11Filters(){const e=document.getElementById("best11-filters");if(!e||0===playerData.length)return;const t=[...new Map(playerData.map(e=>[e["所属クラブ"],e["リーグ"]])).entries()];let n='<button class="filter-btn active" onclick="setBest11Filter(\'all\', null, this)">すべて</button> <button class="filter-btn" onclick="setBest11Filter(\'5-da-league\', null, this)">5大リーグ</button>';["J1","J2","J3"].forEach(e=>{n+=`<button class="filter-btn" onclick="setBest11Filter('league', '${e}', this)">${e}</button>`}),n+='<select id="club-filter-select" onchange="setBest11Filter(\'club\', this.value, this)"> <option value="all">クラブで絞り込み</option>',t.sort().forEach(([e,t])=>{e&&(n+=`<option value="${e}" data-league="${t}">${e}</option>`)}),n+="</select>",e.innerHTML=n}function setBest11Filter(e,t,n){best11Filter={type:e,value:t},document.querySelectorAll("#best11-filters .filter-btn").forEach(e=>e.classList.remove("active")),"BUTTON"===n.tagName?(n.classList.add("active"),document.getElementById("club-filter-select").value="all"):"SELECT"===n.tagName&&"all"===t&&(document.querySelector("#best11-filters .filter-btn[onclick*=\"'all'\"]").classList.add("active"),best11Filter={type:"all",value:null});const a=document.getElementById("club-filter-select"),o=[...new Map(playerData.map(e=>[e["所属クラブ"],e["リーグ"]])).entries()].filter(([e])=>e).sort(),l=["プレミアリーグ","ブンデスリーガ","セリエA","ラリーガ","リーグアン"];let i;i="league"===best11Filter.type?o.filter(([e,t])=>t===best11Filter.value):"5-da-league"===best11Filter.type?o.filter(([e,t])=>l.includes(t)):o;let s='<option value="all">クラブで絞り込み</option>';if(i.forEach(([e,t])=>{s+=`<option value="${e}" data-league="${t}">${e}</option>`}),a.innerHTML=s,"club"===best11Filter.type&&(a.value=best11Filter.value),window.nowSelectedPosKey){const e=document.querySelector(`.position-btn[data-pos="${window.nowSelectedPosKey}"]`);selectPosition(window.nowSelectedPosKey,e)}}function initBest11Page(){renderPositionTabs(),renderBest11Table(),renderCourtPlayers()}function renderPositionTabs(){const e=document.getElementById("position-btn-container");if(!e)return;const t=best11Positions[best11Formation];let n="";t.forEach((e,t)=>{n+=`<button class="position-btn${0===t?" active":""}" data-pos="${e.key}" onclick="selectPosition('${e.key}', this)">${e.label}</button>`}),e.innerHTML=n,setTimeout(()=>selectPosition(t[0].key,e.querySelector(".position-btn")),10)}function renderBest11Table(){const e=document.getElementById("best11-table"),t=[...best11Positions[best11Formation]].sort((e,t)=>(e.key.startsWith("FW")?-1:1)-(t.key.startsWith("FW")?-1:1)||(t.key.startsWith("MF")?1:-1)-(e.key.startsWith("MF")?1:-1)||(t.key.startsWith("CB")?1:-1)-(e.key.startsWith("CB")?1:-1)||("GK"===e.key?1:-1));let n="<table><thead><tr><th>ポジション</th><th>選手</th><th>クラブ</th><th>リーグ</th></tr></thead><tbody>";t.forEach(e=>{let t=best11Selected[e.key]||"",a="",o="";if(t){const e=playerData.find(e=>e["選手名"]===t);e&&(a=e["所属クラブ"]||"",o=e["リーグ"]||"")}n+=`<tr><td style="font-weight:bold;">${e.label}</td><td${t?"":' class="unselected"'}>${t||"未選択"}</td><td>${a||"-"}</td><td>${o||"-"}</td></tr>`}),n+="</tbody></table>",e.innerHTML=n}function renderCourtPlayers(){const e=document.getElementById("court-area");e&&(e.innerHTML="",best11Positions[best11Formation].forEach(t=>{const n=best11PosCoords[best11Formation][t.key];if(!n)return;const a=document.createElement("div");a.className="best11-player-label"+(best11Selected[t.key]?"":" unselected")+(t.key===window.nowSelectedPosKey?" selected":""),a.style.top=`${n.top}px`,a.style.left=`${n.left}px`;let o=best11Selected[t.key]?best11Selected[t.key]:t.label,l=o.length>=7?"0.80em":o.length>=6?"0.89em":"1em";a.innerHTML=`<span style="font-size:${l};">${o}</span>`,a.onclick=()=>selectPosition(t.key,document.querySelector(`.position-btn[data-pos="${t.key}"]`)),a.style.cursor="pointer",e.appendChild(a)}))}function setupEventListeners(){const e=document.getElementById("hamburger-btn"),t=document.getElementById("nav-links"),n=document.getElementById("menu-overlay");if(e&&t&&n){const a=()=>{const e=t.classList.toggle("open");n.classList.toggle("open"),e||document.querySelectorAll(".nav-dropdown.menu-open").forEach(e=>{e.classList.remove("menu-open")})};e.addEventListener("click",a),n.addEventListener("click",a)}function a(e,t,n){try{const a=document.createElement("a"),o=e.toDataURL("image/png");a.href=o,a.download=t,document.body.appendChild(a),a.click(),document.body.removeChild(a);/iPad|iPhone|iPod/.test(navigator.userAgent)&&window.MSStream;n.textContent="",setTimeout(()=>n.textContent="",5e3)}catch(e){console.error("画像のダウンロードに失敗しました:",e),n.textContent="エラー: 画像のダウンロードに失敗しました"}}document.querySelectorAll(".country-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".country-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),showPlayerTable(e.dataset.country)})}),document.querySelectorAll(".league-tab-btn").forEach(e=>{e.addEventListener("click",function(){document.querySelectorAll(".league-tab-btn").forEach(e=>e.classList.remove("active")),this.classList.add("active"),renderClubLeagueTable(this.dataset.league)})}),document.getElementById("post-to-x-btn").onclick=function(){const e=`https://x.com/intent/tweet?text=${encodeURIComponent("私のベストイレブンはこちら！\n#あなたのベストイレブン")}&url=${encodeURIComponent("https://jleague-big-club.com")}`;window.open(e,"_blank");const t=document.getElementById("copy-best11-img-msg");/iPad|iPhone|iPod/.test(navigator.userAgent)&&window.MSStream;t.textContent="",setTimeout(()=>t.textContent="",5e3)},document.getElementById("copy-best11-img-btn").onclick=function(){const e=this,t=document.getElementById("post-to-x-btn"),n=document.getElementById("best11-capture-area"),o=document.getElementById("capture-buttons"),l=document.getElementById("copy-best11-img-msg"),i=n.querySelector(".best11-player-label.selected");i&&i.classList.remove("selected"),e.disabled=!0,t.disabled=!0,o.style.visibility="hidden",l.style.visibility="hidden",l.textContent="",html2canvas(n,{backgroundColor:null,scale:2,useCORS:!0}).then(e=>{i&&i.classList.add("selected"),e.toBlob(t=>{t?navigator.clipboard&&navigator.clipboard.write?navigator.clipboard.write([new ClipboardItem({"image/png":t})]).then(()=>{l.textContent="",setTimeout(()=>l.textContent="",3e3)}).catch(t=>{console.warn("クリップボードへのコピーに失敗しました (iOSの制限など):",t),a(e,"best11.png",l)}):(console.warn("Clipboard APIがサポートされていません。画像をダウンロードします。"),a(e,"best11.png",l)):l.textContent="エラー: 画像データの生成に失敗しました"},"image/png")}).catch(e=>{console.error("画像キャプチャ中にエラーが発生しました:",e),l.textContent="エラー: 画像のキャプチャに失敗しました"}).finally(()=>{e.disabled=!1,t.disabled=!1,o.style.visibility="visible",l.style.visibility="visible"})};const o=document.getElementById("score-method-btn"),l=document.getElementById("score-method-pop"),i=document.getElementById("score-detail-link"),s=document.getElementById("score-detail-pop");o&&(o.onclick=e=>{e.stopPropagation(),l.classList.toggle("popup-visible"),s.classList.remove("popup-visible")}),i&&(i.onclick=e=>{e.preventDefault(),e.stopPropagation(),s.classList.add("popup-visible")}),document.addEventListener("click",e=>{const t=document.getElementById("club-status-board");!t||"block"!==t.style.display||t.contains(e.target)||e.target.matches("td[onclick^='showClubStatus']")||(t.style.display="none"),l&&l.classList.contains("popup-visible")&&!l.contains(e.target)&&l.classList.remove("popup-visible"),s&&s.classList.contains("popup-visible")&&!s.contains(e.target)&&!i.contains(e.target)&&s.classList.remove("popup-visible")});const r=document.querySelector(".score-calc-btn");if(r){const e=r.querySelector(".score-calc-pop");e&&r.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();const n="block"===e.style.display;e.style.display=n?"none":"block"})}document.addEventListener("click",e=>{const t=document.getElementById("club-status-board");!t||"block"!==t.style.display||t.contains(e.target)||e.target.matches("td[onclick^='showClubStatus']")||(t.style.display="none");const n=document.getElementById("score-method-pop");n&&n.classList.contains("popup-visible")&&!n.contains(e.target)&&n.classList.remove("popup-visible");const a=document.getElementById("score-detail-pop");a&&a.classList.contains("popup-visible")&&!a.contains(e.target)&&!document.getElementById("score-detail-link").contains(e.target)&&a.classList.remove("popup-visible");const o=document.getElementById("prediction-help-pop"),l=document.getElementById("prediction-help-btn");!o||"block"!==o.style.display||o.contains(e.target)||l.contains(e.target)||(o.style.display="none");const i=document.querySelector(".score-calc-pop"),s=document.querySelector(".score-calc-btn");i&&s&&("block"!==i.style.display||s.contains(e.target)||(i.style.display="none"));const r=document.querySelector(".custom-select-container.open");r&&!r.contains(e.target)&&r.classList.remove("open")})}window.setFormation=function(e,t){best11Formation=e,document.getElementById("formation-title").textContent="フォーメーション："+t.textContent,document.querySelectorAll(".formation-btn").forEach(e=>e.classList.remove("active")),t.classList.add("active"),best11Selected={},best11Filter={type:"all",value:null},initBest11Page(),document.querySelectorAll("#best11-filters .filter-btn").forEach(e=>e.classList.remove("active")),document.querySelector("#best11-filters .filter-btn").classList.add("active");const n=document.getElementById("club-filter-select");n&&(n.value="all")},window.selectPosition=function(e,t){window.nowSelectedPosKey=e,document.querySelectorAll("#position-tabs .position-btn").forEach(e=>e.classList.remove("active")),t&&t.classList.add("active");let n,a=document.getElementById("player-choice-list");if(!a)return;const o=["プレミアリーグ","ブンデスリーガ","セリエA","ラリーガ","リーグアン"];switch(best11Filter.type){case"league":n=playerData.filter(e=>e["リーグ"]===best11Filter.value);break;case"club":n=playerData.filter(e=>e["所属クラブ"]===best11Filter.value);break;case"5-da-league":n=playerData.filter(e=>o.includes(e["リーグ"]));break;default:n=playerData}const l=e.replace(/[0-9]/g,"").toUpperCase();let i=n.filter(e=>{const t=(e["ポジション"]||"").toUpperCase();return t===l||"CB"===l&&"DF"===t});if(0===i.length)a.innerHTML='<div style="color:white; padding: 10px;">この条件の選手がいません。</div>';else{const t=best11Selected[e]||"選手を選択...";let n='<div class="custom-option" data-value="">選手を選択...</div>';i.forEach(e=>{const t=e["選手名"];n+=`<div class="custom-option" data-value="${t}">${t}</div>`}),a.innerHTML=` <div class="custom-select-container"> <button class="custom-select-trigger">${t}</button> <div class="custom-options">${n}</div> </div>`;const o=a.querySelector(".custom-select-container"),l=o.querySelector(".custom-select-trigger"),s=o.querySelectorAll(".custom-option");l.addEventListener("click",e=>{e.stopPropagation(),o.classList.toggle("open")}),s.forEach(t=>{t.addEventListener("click",function(){const t=this.getAttribute("data-value");choosePlayer(e,t),l.textContent=t||"選手を選択...",o.classList.remove("open")})})}renderCourtPlayers()},window.choosePlayer=function(e,t){t?best11Selected[e]=t:delete best11Selected[e],renderBest11Table(),renderCourtPlayers()};const articlesPerPage=18;let currentPage=1;function renderArticleList(e){currentPage=e;const t=document.getElementById("blog-list-container"),n=document.getElementById("pagination");t&&(t.innerHTML=""),n&&(n.style.display="block");const a=(e-1)*articlesPerPage;blogPosts.slice(a,a+articlesPerPage).forEach(e=>{const n=document.createElement("div");n.className="blog-card",n.innerHTML=`<img src="/${e.thumbnail}" alt="${e.title}"><div class="blog-card-content"><div class="blog-card-title">${e.title}</div><div class="blog-card-date">${e.date}</div></div>`,n.onclick=()=>showArticleDetail(e.slug,e.title),t&&t.appendChild(n)}),renderPagination()}function renderPagination(){const e=document.getElementById("pagination");if(!e)return;e.innerHTML="";const t=Math.ceil(blogPosts.length/articlesPerPage);if(!(t<=1))for(let n=1;n<=t;n++){const t=document.createElement("button");t.textContent=n,t.style.cssText=`margin:0 5px; padding:6px 14px; border:none; border-radius:5px; cursor:pointer; background:${n===currentPage?"#299ad3":"#eee"}; color:${n===currentPage?"#fff":"#333"};`,t.onclick=()=>{renderArticleList(n),window.scrollTo({top:0,behavior:"smooth"})},e.appendChild(t)}}function showRankingTable(e){document.querySelectorAll("#rank-buttons .rank-tab-btn").forEach(e=>e.classList.remove("active"));const t=document.querySelector(`#rank-buttons .rank-tab-btn[onclick="showRankingTable('${e}')"]`);t&&t.classList.add("active");const n=document.getElementById("ranking-table-container");if(!n)return;const{data:a,updated:o}=rankingData[e];if(!a||0===a.length)return void(n.innerHTML="<p>順位データがありません。</p>");const l=window.innerWidth<=768;let i="";if(o){i=`<p class="update-date-note">更新日時: ${new Date(o).toLocaleString("ja-JP",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}</p>`}const s=Object.keys(a[0]),r=l?s.filter(e=>"勝点"!==e):s;let c="<table><thead><tr>";r.forEach(e=>{c+=`<th>${e}</th>`}),c+="</tr></thead><tbody>",a.forEach(e=>{c+="<tr>",r.forEach(t=>{let n=e[t]||"";if("チーム名"===t&&l){const e=toHalfWidth(n);let t=n;for(const n in clubAbbreviations)if(toHalfWidth(n)===e){t=clubAbbreviations[n];break}n=t}c+=`<td>${n}</td>`}),c+="</tr>"}),c+="</tbody></table>",n.innerHTML=i+c}let simInitialized=!1;function getCategoryInfo(e){return e>=50?{text:"ビッグクラブ",color:"#ffd700"}:e>=30?{text:"有望ビッグクラブ",color:"#e94444"}:e>=20?{text:"潜在的ビッグクラブ",color:"#41cdf4"}:e>=5?{text:"中堅クラブ",color:"#bbb"}:{text:"ローカルクラブ",color:"#999"}}function initSimulationPage(){const e=document.getElementById("sim-league-select");if(e){if(!simInitialized){const t=document.getElementById("sim-club-select"),n=document.querySelectorAll(".sim-input");e.addEventListener("change",()=>{populateClubSelect(e.value)}),t.addEventListener("change",()=>{displayClubData(t.value)}),n.forEach(e=>{e.addEventListener("input",runSimulation)}),simInitialized=!0}e.innerHTML='<option value="">まずリーグを選択...</option>',["J1","J2","J3"].forEach(t=>{e.innerHTML+=`<option value="${t}">${t}</option>`}),populateClubSelect("")}else console.error("シミュレーションページの要素が見つかりませんでした。HTMLの構造を確認してください。")}function populateClubSelect(e){const t=document.getElementById("sim-club-select"),n=document.querySelectorAll(".sim-input");if(t.innerHTML='<option value="">クラブを選択...</option>',t.disabled=!0,n.forEach(e=>{e.value="",e.disabled=!0}),document.getElementById("sim-result-area").innerHTML="<p>クラブを選択すると、ここにスコアが表示されます。</p>",!e)return;clubData.filter(t=>t.p===e).sort((e,t)=>e.name.localeCompare(t.name,"ja")).forEach(e=>{t.innerHTML+=`<option value="${e.name}">${e.name}</option>`}),t.disabled=!1}function displayClubData(e){const t=document.querySelectorAll(".sim-input"),n=document.getElementById("sim-result-area");if(!e)return t.forEach(e=>{e.value="",e.disabled=!0}),void(n.innerHTML="<p>クラブを選択すると、ここにスコアが表示されます。</p>");t.forEach(e=>e.disabled=!1);const a=clubData.find(t=>t.name===e);if(!a)return;document.getElementById("sim-revenue").value=a.revenue||"",document.getElementById("sim-audience").value=a.audience||"",document.getElementById("sim-titles").value=a.titles||"",document.getElementById("sim-avg-rank").value=a.m||"";const o=a.sum||0,l=getCategoryInfo(o);n.innerHTML=` <div class="sim-current-score"> 現在の区分: <span style="color: ${l.color}; font-weight: bold;">${l.text}</span><br> 現在のビッグクラブスコア: <strong>${o.toFixed(2)}</strong> </div> <div class="sim-new-score"> <p style="margin:0; font-size:0.8em; color:#ccc;">数値を変更してください</p> </div> `}function runSimulation(){const e=document.getElementById("sim-club-select").value;if(!e)return;const t=clubData.find(t=>t.name===e);if(!t)return;const n=parseFloat(document.getElementById("sim-revenue").value)||t.revenue,a=parseInt(document.getElementById("sim-audience").value)||t.audience,o=parseInt(document.getElementById("sim-titles").value)||t.titles,l=parseFloat(document.getElementById("sim-avg-rank").value)||parseFloat(t.m),i=t.sum||0,s=getCategoryInfo(i),r=calculateBigClubScore(n,a,o,l),c=getCategoryInfo(r);document.getElementById("sim-result-area").innerHTML=` <div class="sim-current-score"> 現在の区分: <span style="color: ${s.color}; font-weight: bold;">${s.text}</span><br> 現在のビッグクラブスコア: <strong>${i.toFixed(2)}</strong> </div> <div class="sim-new-score"> 予測区分: <span style="color: ${c.color}; font-weight: bold;">${c.text}</span><br> 予測スコア <span class="arrow">→</span> <span class="score-value">${r.toFixed(2)}</span> </div> `}function calculateBigClubScore(e,t,n,a){if(isNaN(e)||isNaN(t)||isNaN(n)||isNaN(a)||a>21)return 0;const o=.3*(e/200*100)+.15*(t/45e3*100)+.25*(n/98*100)+.3*(21-a);return Math.max(0,o)}function startBannerAutoPlay(e,t){stopBannerAutoPlay(),bannerAutoPlayInterval=setInterval(t,e)}function stopBannerAutoPlay(){clearInterval(bannerAutoPlayInterval)}function setupCarousel(e,t){let n=document.getElementById(e);if(!n)return;const a=n.cloneNode(!0);n.parentNode.replaceChild(a,n),n=a;const o=n.querySelector(".carousel-track"),l=Array.from(o.children),i=document.getElementById("carousel-prev-btn"),s=document.getElementById("carousel-next-btn"),r=window.innerWidth>768?2:1;if(l.length<=r)return i&&(i.style.display="none"),void(s&&(s.style.display="none"));const c=l.length;for(let e=0;e<r;e++)o.appendChild(l[e].cloneNode(!0));let d=0,u=!1;function p(){const e=100/r;o.style.transform=`translateX(-${d*e}%)`}function m(){u||(u=!0,o.style.transition="transform 400ms ease-in-out",d++,p(),setTimeout(()=>{u=!1},500))}o.addEventListener("transitionend",()=>{d>=c&&(o.style.transition="none",d=0,p(),setTimeout(()=>{o.style.transition="transform 400ms ease-in-out"},20))}),s.addEventListener("click",()=>{stopBannerAutoPlay(),m(),startBannerAutoPlay(t,m)}),i.addEventListener("click",()=>{stopBannerAutoPlay(),u||(u=!0,d<=0?(o.style.transition="none",d=c,p(),setTimeout(()=>{o.style.transition="transform 400ms ease-in-out",d--,p()},20)):(o.style.transition="transform 400ms ease-in-out",d--,p()),setTimeout(()=>{u=!1},500)),startBannerAutoPlay(t,m)}),n.addEventListener("mouseenter",stopBannerAutoPlay),n.addEventListener("mouseleave",()=>startBannerAutoPlay(t,m)),startBannerAutoPlay(t,m)}let attendanceInitialized=!1,attendanceChart=null;function initAttendancePage(){if(attendanceInitialized)return;const e=document.getElementById("attendance-year-select"),t=[...new Set(attendanceData.map(e=>e.年))].sort((e,t)=>t-e);e.innerHTML="",t.forEach(t=>{e.innerHTML+=`<option value="${t}">${t}年</option>`}),e.addEventListener("change",updateAttendanceFilters);const n=document.getElementById("attendance-league-btns");let a='<button class="rank-tab-btn active" data-league="all">全て</button>';[...new Set(attendanceData.map(e=>e.リーグ))].filter(Boolean).sort().forEach(e=>{a+=`<button class="rank-tab-btn" data-league="${e}">${e}</button>`}),n.innerHTML=a,n.querySelectorAll(".rank-tab-btn").forEach(e=>{e.addEventListener("click",()=>{n.querySelectorAll(".rank-tab-btn").forEach(e=>e.classList.remove("active")),e.classList.add("active"),updateAttendanceFilters()})}),document.getElementById("attendance-club-select").addEventListener("change",e=>{e.target.value&&"all"!==e.target.value?renderAttendanceChart(e.target.value):updateAttendanceFilters()}),updateAttendanceFilters(),attendanceInitialized=!0}function updateAttendanceFilters(){const e=parseInt(document.getElementById("attendance-year-select").value),t=document.querySelector("#attendance-league-btns .rank-tab-btn.active"),n=t?t.dataset.league:"all",a=document.getElementById("attendance-club-select"),o=attendanceData.filter(t=>t.年===e&&("all"===n||t.リーグ===n)),l=[...new Set(o.map(e=>e.クラブ))].sort((e,t)=>e.localeCompare(t,"ja"));let i='<option value="all">クラブを選択...</option>';l.forEach(e=>{i+=`<option value="${e}">${e}</option>`}),a.innerHTML=i;renderAttendanceTable(attendanceData.filter(t=>t.年===e&&("all"===n||t.リーグ===n)))}function renderAttendanceTable(e){document.getElementById("attendance-chart-wrap").style.display="none";const t=document.getElementById("attendance-output-container");t.style.display="block";const n=e||[],a={J1:"#e94444",J2:"#29b6e6",J3:"#6cbf6b",JFL:"#f2a136",default:"#ffffff"};let o="";if(attendanceData.lastModified){o=`<div style="text-align: right; font-size: 0.85em; color: #aabbcc; margin-bottom: 8px;"> 更新日時: ${new Date(attendanceData.lastModified).toLocaleString("ja-JP",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})} </div>`}let l='<table style="background: #f9fcff; color: #21304c;"> <thead><tr>';["順位","リーグ","クラブ","平均観客数","年間最高観客数","年間最低観客数","ゲーム数"].forEach(e=>l+=`<th style="background: linear-gradient(90deg, #27aee7 65%, #b0e7fa 100%); color: #fff;">${e}</th>`),l+="</tr></thead> <tbody>",n.sort((e,t)=>t.平均観客数-e.平均観客数).forEach((e,t)=>{const n=a[e.リーグ]||a.default,o=window.innerWidth<=768,i=o&&clubAbbreviations[e.クラブ]||e.クラブ,s=o?Math.round(e.平均観客数):e.平均観客数,r=o?Math.round(e.年間最高観客数):e.年間最高観客数,c=o?Math.round(e.年間最低観客数):e.年間最低観客数;l+=`<tr style="cursor: pointer; background: ${t%2==0?"#f2f6fa":"#ffffff"};" onclick="renderAttendanceChart('${e.クラブ}')" onmouseover="this.style.backgroundColor='#e0f7ff';" onmouseout="this.style.backgroundColor='${t%2==0?"#f2f6fa":"#ffffff"}';">`,l+=`<td>${t+1}</td>`,l+=`<td style="background-color: ${n}; color: #fff; font-weight: bold;">${e.リーグ}</td>`,l+=`<td>${i}</td>`,l+=`<td>${s.toLocaleString()}</td>`,l+=`<td>${r.toLocaleString()}</td>`,l+=`<td>${c.toLocaleString()}</td>`,l+=`<td>${e.ゲーム数}</td></tr>`}),l+="</tbody></table>",t.innerHTML=o+l}function renderAttendanceChart(e){document.getElementById("attendance-output-container").style.display="none";const t=document.getElementById("attendance-chart-wrap"),n=document.getElementById("attendanceChart");t.style.display="block";const a=attendanceData.filter(t=>t.クラブ===e).sort((e,t)=>e.年-t.年),o=a.map(e=>e.年),l={J1:"#e94444",J2:"#29b6e6",J3:"#6cbf6b",JFL:"#f2a136",default:"#aaaaaa"};attendanceChart&&attendanceChart.destroy();const i=n.getContext("2d");attendanceChart=new Chart(i,{type:"line",data:{labels:o,datasets:[{label:`${e} の平均観客数推移`,segment:{borderColor:e=>l[e.p1.raw.league]||l.default},data:a.map(e=>({x:e.年,y:e.平均観客数,league:e.リーグ})),spanGaps:!0,tension:.1,pointRadius:5,pointHoverRadius:7,pointBackgroundColor:e=>l[a[e.dataIndex]?.リーグ]||l.default,pointBorderColor:"#fff",pointBorderWidth:2,pointHitRadius:20}]},// ▼▼▼ 修正後 ▼▼▼
options:{responsive:!0,maintainAspectRatio:!1,scales:{x:{type:"linear",title:{display:!0,text:"年",color:"#333"},ticks:{stepSize:1,callback:function(e){if(Number.isInteger(e))return e},maxTicksLimit:window.innerWidth<=768?8:void 0}},y:{beginAtZero:!0,title:{display:!0,text:"平均観客数（人）",color:"#333"}}},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>` ${e.raw.league}: ${e.raw.y.toLocaleString()} 人`,title:e=>`${e[0].raw.x}年`}}}}});const s=document.getElementById("attendance-chart-footer");s.innerHTML="";const r=document.createElement("div");r.style.cssText="display: flex; justify-content: space-between; align-items: center;";const c=document.createElement("div");c.style.cssText="display: flex; gap: 15px;";[...new Set(a.map(e=>e.リーグ))].forEach(e=>{const t=l[e]||l.default,n=document.createElement("div");n.style.cssText="display: flex; align-items: center; font-size: 0.9em; color: #333;",n.innerHTML=`<span style="display: inline-block; width: 20px; height: 4px; background-color: ${t}; margin-right: 5px;"></span> ${e}`,c.appendChild(n)});const d=document.createElement("button");d.innerHTML="‹ 表に戻る",d.style.cssText="padding: 5px 12px; font-size: 0.85em; font-weight: bold; cursor: pointer; border: 1px solid #ccc; background: #f0f0f0; border-radius: 5px;",d.onclick=()=>{document.getElementById("attendance-chart-wrap").style.display="none",document.getElementById("attendance-output-container").style.display="block"},r.appendChild(c),r.appendChild(d),s.appendChild(r)}function initEuropeMobilePage(){const e=document.getElementById("europe-league-selector"),t=document.getElementById("europe-player-list");let n="<h3>リーグを選択してください</h3>";majorLeagues.forEach(e=>{n+=`<button class="rank-tab-btn" style="width:100%; margin: 6px 0; padding: 14px;" onclick="renderEuropePlayerList('${e}')">${e}</button>`}),e.innerHTML=n,t.innerHTML="",e.style.display="block",t.style.display="none"}function renderEuropePlayerList(e){const t=document.getElementById("europe-league-selector"),n=document.getElementById("europe-player-list"),a="ラ・リーガ"===e?"ラリーガ":"リーグ・アン"===e?"リーグアン":e,o=playerData.filter(e=>e["リーグ"]===a).sort((e,t)=>(parseInt(e["年齢"])||99)-(parseInt(t["年齢"])||99));let l='<button class="rank-tab-btn" style="width:100%; margin: 6px 0 20px 0; padding: 10px; background: #6c757d;" onclick="initEuropeMobilePage()">‹ リーグ選択に戻る</button>';l+=`<h3 class="page-subtitle">${e} の日本人選手</h3>`,0===o.length?l+="<p>このリーグに所属する日本人選手の情報はありません。</p>":o.forEach(e=>{l+=` <div class="player-card-mobile"> <div class="player-info"> <h3>${e["選手名"]}</h3> <p><strong>所属クラブ:</strong> <span>${e["所属クラブ"]}</span></p> <p><strong>年齢:</strong> <span>${e["年齢"]}</span></p> <p><strong>ポジション:</strong> <span>${e["ポジション"]}</span></p> </div> <div class="player-image"> <img src="img/player.png" alt="選手アイコン"> </div> </div>`}),n.innerHTML=l,t.style.display="none",n.style.display="block",window.scrollTo(0,0)}function setupFooterButtonObserver(){const e=document.getElementById("score-method-btn"),t=document.querySelector(".site-footer");if(window.innerWidth<=768)return void(e&&e.classList.add("fixed-to-viewport"));if(!e||!t)return;new IntersectionObserver(t=>{t.forEach(t=>{t.isIntersecting?e.classList.remove("fixed-to-viewport"):e.classList.add("fixed-to-viewport")})},{root:null,rootMargin:"0px",threshold:0}).observe(t)}function showPredictionView(e){const t=document.getElementById("prediction-league-tabs");if(t){t.querySelectorAll(".rank-tab-btn").forEach(e=>e.classList.remove("active"));const n=t.querySelector(`.rank-tab-btn[onclick="showPredictionView('${e}')"]`);n&&n.classList.add("active")}renderPrediction(e)}function renderPrediction(e){const t=document.getElementById("prediction-container"),n=predictionProbabilities[e];if(!n)return void(t.innerHTML='<p style="text-align:center;">予測データを生成できませんでした。</p>');let a="";const o=updateDates["prediction_probabilities.json"];if(o){a=`<p class="update-date-note">更新日時: ${new Date(o).toLocaleString("ja-JP",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}</p>`}const l=Object.keys(n).map(e=>({name:e,...n[e]})),i=(e,t)=>e.map((e,t)=>({item:e,index:t})).sort((e,n)=>{const a=t(e.item,n.item);return 0!==a?a:e.index-n.index}).map(({item:e})=>e),s={champion:i(l,(e,t)=>t.champion-e.champion).slice(0,5).filter(e=>e.champion>0),acl:i(l,(e,t)=>t.acl-e.acl).slice(0,5).filter(e=>e.acl>0),promotion:i(l,(e,t)=>t.promotion-e.promotion).slice(0,5).filter(e=>e.promotion>0),relegation:i(l,(e,t)=>t.relegation-e.relegation).slice(0,5).filter(e=>e.relegation>0),full_ranking:i(l,(e,t)=>t.safe-e.safe).slice(0,15)},r={champion:{title:"🏆 優勝確率 TOP5",probKey:"champion",className:"champion"},acl:{title:"🌐 ACL出場圏確率 TOP5",probKey:"acl",className:"acl"},promotion:{title:"⬆️ 昇格確率 TOP5",probKey:"promotion",className:"promotion"},relegation:{title:"⚠️ 降格確立 TOP5",probKey:"relegation",className:"relegation"},full_ranking:{title:"✅ 残留以上確率 TOP15",probKey:"safe",className:"safe"}};let c;"J1"===e?(r.relegation.title="⚠️ J2降格確立 TOP5",c=["champion","relegation","full_ranking","acl"]):"J2"===e?(r.promotion.title="⬆️ J1昇格確率 TOP5",r.relegation.title="⚠️ J3降格確立 TOP5",c=["promotion","relegation","full_ranking"]):"J3"===e?(r.promotion.title="⬆️ J2昇格確率 TOP5",r.relegation.title="⚠️ JFL降格確立 TOP5",c=["promotion","relegation","full_ranking"]):c=[];let d='<div class="prediction-grid">';c.forEach(e=>{const t=s[e];if(!t||0===t.length)return;const n=r[e];d+=` <div class="prediction-card"> <div class="prediction-card-header ${n.className}"> ${n.title} </div> <div class="prediction-card-body"> <ul class="prediction-list"> ${t.map((e,t)=>{const a=e[n.probKey],o=null!=a?`${(100*a).toFixed(1)}%`:"";return` <li> <div class="rank-team"> <span class="rank">${t+1}位</span> <span class="team-name">${e.name}</span> </div> ${o?`<span class="probability">${o}</span>`:""} </li>`}).join("")} </ul> </div> </div> `}),d+="</div>",t.innerHTML=a+d}